!function(){function a(){}a.prototype.parse=function(a){for(var b=[],c={},d=a.split(/\s*(;|\(|\)|,|:)\s*/),e=0;e<d.length;e++){var f=d[e];switch(f){case"(":var g={};c.branchset=[g],b.push(c),c=g;break;case",":var g={};b[b.length-1].branchset.push(g),c=g;break;case")":c=b.pop();break;case":":break;default:var h=d[e-1];")"==h||"("==h||","==h?c.name=f:":"==h&&(c.length=parseFloat(f))}}return c};var b=a.prototype;[["parse",b.parse]],$.newick={},$.newick.parse=b.parse}(),function(){$.stage={current:-1,last:0,round:function(){if(this.current<this.last)this.current+=1,this.set(this.current);else if(this.current===this.last)return this.end=!0,$.timer.stop(),document.getElementById("endGameSound").play(),$.endGame.complete(),"end game"},set:function(a){0==a&&$.timer.start(),$.engine.deActive(),$(".boardRow").removeClass("current").removeClass("blocked");var b=function(a){var b=$.phylo.tree[a];0==b.child?($("#row"+b.node1).hide().show("slide",{direction:"right"},500),$("#row"+b.node2).hide().show("slide",{direction:"right"},500)):1==b.child&&$("#row"+b.node1).hide().show("slide",{direction:"right"},500)},c=function(a){var b=$.phylo.tree[a];0==b.child?($("#row"+b.node1).removeClass("hidden").addClass("current"),$("#row"+b.node2).removeClass("hidden").addClass("current")):1==b.child?($("#row"+b.node1).removeClass("hidden").addClass("current"),c(b.node2)):2==b.child&&(c(b.node1),c(b.node2))};this.splash(a),b(a),c(a),0==a&&$("#bg").show("slide",{direction:"left"},400),$(".boardRow").each(function(){0==$(this).hasClass("hidden")&&0==$(this).hasClass("current")&&$(this).addClass("blocked")});var a=$.phylo.tree[a];$.engine.active(),$.tree.buildAncestor();var d=[];$.phylo.bestTrack=[];for(var e=0;8>e;e++){for(var f=[],g=0;25>g;g++)f.push(0);d.push(f),$.phylo.bestTrack.push(f)}$.helper.copy(d,$.sequence.track),$.helper.copy($.sequence.track,$.phylo.origin);var h=$.fitch.score();$.helper.copy($.sequence.track,d),$.sequence.par=h,$.board.par(h);var i=$.fitch.score();$.phylo.bestScore=i,$.board.score(i),$.helper.copy($.phylo.bestTrack,$.sequence.track),$.board.bestScore(i),i>=h?$.board.approve():$.board.unapprove(),$.board.stats()},end:!1,splash:function(a){var b="Stage";try{b=window.lang.body.play.gameselect["game board"]["field 3"]}catch(c){}$("#splash").html(b+" "+(a+1)).show(),window.setTimeout(function(){$("#splash").fadeOut("fast")},800)}}}(),function(){$.board={build:function(){$("#gameBoard").html("<canvas width='827px' height='332px' id='canvasBG'></canvas>"),this.redrawBG()},redrawBG:function(){var a=document.getElementById("canvasBG"),b=a.getContext("2d");b.globalAlpha=1,b.clearRect(0,0,827,350);for(var c=0;c<$.phylo.seqLen+1;c++)b.beginPath(),b.lineWidth=2,b.moveTo($.sequence.calcPos(c)+1,0),b.lineTo($.sequence.calcPos(c)+1,350),b.strokeStyle="#C4C4C4",b.stroke(),b.closePath();for(var c=0;c<$.phylo.rows+1;c++)b.beginPath(),b.lineWidth=2,b.moveTo(0,$.sequence.calcPos(c)+1),b.lineTo(827,$.sequence.calcPos(c)+1),b.strokeStyle="#C4C4C4",b.stroke(),b.closePath()},score:function(a){$.phylo.currentScore=a,$("#userScore").html("Score: "+a),$.html5.score.setScore(a)},bestScore:function(a){$("#bestScore").html("Best: "+a),$.stage.current==$.stage.last&&a>$.sequence.par&&$.protocal.sendHighScore()},par:function(a){$("#parScore").html("Par: "+a)},stats:function(){var a=window.lang.body.play.gameselect["game board"];void 0==$.stage.stats?$("#statsPanel").html(a["field 3"]+": "+($.stage.current+1)+"/"+($.stage.last+1)):$("#statsPanel").html("<i class='icon-puzzle'></i> ID:&nbsp;&nbsp;"+$.phylo.id+"<br>"+a["field 3"]+": "+($.stage.current+1)+"/"+($.stage.last+1)+"<span class='gap'></span>"+a["field 9"]+": "+$.stage.stats.match+"<span class='gap'></span>"+a["field 10"]+": "+$.stage.stats.mismatch+"<span class='gap'></span>"+a["field 11"]+": "+$.stage.stats.open+"<span class='gap'></span>"+a["field 12"]+": "+$.stage.stats.extend+"<span class='gap'><span>"+a["field 2"]+": "+$.sequence.par)},startListener:function(){var a=this,b=document.getElementById("starClickSound");0==window.DEV.disableMusic&&$("#musicPlayerSpot").html("<audio loop='loop' id='game-audio' preload='auto' autobuffer style='display:none'><source src='assets/sounds/Valent%20-%20The%20Buckle.ogg' type='audio/ogg'/><source src='assets/sounds/Valent%20-%20The%20Buckle.mp3' type='audio/mp3'/>Your browser does not support audio element</audio>");var c=["#customize-music","#customize-countdown","#customize-redraw","#customize-star","#customize-fxOthers"];for(var d in c)$(c[d]).trigger("click"),$(c[d]).trigger("click");$("#scorePanel").hide(),$("#cycle").unbind().click(function(){$.helper.copy($.sequence.track,$.phylo.bestTrack);var b=$.fitch.score();$.board.score(b),$.physics.snapRandom(),$.phylo.bestScore>=$.sequence.par&&$.board.approve(),a.stats()}),DEBUG&&console.log("bindings are done!"),$("#undo").unbind().click(function(){$("#moveListener").trigger("undoMove")}),$("#redo").unbind().click(function(){$("#moveListener").trigger("redoMove")}),$("#star").unbind().click(function(){b.play(),$.phylo.currentScore>=$.sequence.par&&$.stage.round()})},approve:function(){var a=this;document.getElementById("lightUpSound"),$("#star").addClass("pass"),$("#star").animate({opacity:1},300,function(){return $.phylo.currentScore<$.sequence.par?(a.unapprove(),void 0):(lightUpSound.play(),$("#star").animate({opacity:.2},300,function(){return $.phylo.currentScore<$.sequence.par?(a.unapprove(),void 0):($("#star").animate({opacity:1},500,function(){return $.phylo.currentScore<$.sequence.par?(a.unapprove(),void 0):($("#star").animate({opacity:.2},300,function(){return $.phylo.currentScore<$.sequence.par?(a.unapprove(),void 0):($("#star").animate({opacity:1},500,function(){return $.phylo.currentScore<$.sequence.par?(a.unapprove(),void 0):void 0}),void 0)}),void 0)}),void 0)}),void 0)})},unapprove:function(){$("#star").removeClass("pass"),$("#star").css({opacity:.4})},getSubmissionAlignments:function(){for(var a=this,b=$.sequence.track,c="[",d=0;d<b.length;d++){c+='{"';for(var e=0;e<b[d].length;e++)c+="x"==b[d][e]?"-":0!=d&&0==b[d][e]?"":a.convertColor($("#"+b[d][e]));c+='"}',d<b.length-2&&(c+=",")}return'{"alignments" : '+c+"]}"},getJsonAlignments:function(){var a=$.extend(!0,[],$.sequence.track);return{alignments:a,stage:$.stage.current}},convertColor:function(a){return a.hasClass("nuc-G")?"G":a.hasClass("nuc-C")?"C":a.hasClass("nuc-A")?"A":a.hasClass("nuc-T")?"T":null}}}(),function(){$.timer={elapsed:0,active:!1,count:function(){this.elapsed+=1},start:function(){0!=$("#game").length&&(this.elapsed=0,this.timer=setInterval("$.timer.count()",1e3),this.active=!0)},stop:function(){clearInterval(this.timer),this.active=!1}}}(),function(){$.html5={},$.html5.score={settings:{wBox:827,hBox:50,w:827/14.5,par:"#FF0000",current:"#6495ED",best:"#66CD00",color:"#6D6D6D",prev:0,prevMid:4},setScore:function(a){this.draw(a),document.getElementById("redrawSound").play()},draw_old:function(){var a=this,b=document.getElementById("score"),c=b.getContext("2d");c.globalAlpha=1,c.clearRect(0,0,a.settings.wBox,a.settings.hBox),this.setBorder(),this.drawCurrent(c),this.drawPar(c),this.drawBest(c),this.drawScale(c),this.dra4Key(c),this.settings.prev=$.phylo.currentScore,this.settings.prevPar=$.sequence.par},draw:function(){$.highlighter.set();var a=this,b=document.getElementById("score"),c=b.getContext("2d");c.globalAlpha=1,c.clearRect(0,0,a.settings.wBox,a.settings.hBox),this.setBorder(),this.drawScale2(c),this.settings.prev=$.phylo.currentScore},drawDelay:function(a){var b=this,c=$.phylo.currentScore,d=b.getDistance(c),e=b.getDistance(b.settings.prev),f=e-d,g=function(c){a.beginPath(),a.clearRect(0,0,765,b.settings.hBox),a.fillStyle=b.settings.current,a.fillRect(b.settings.w*b.midPoint,5,e+c,30),a.closePath(),f>0?c-=8:c+=8,b.drawPar(a),b.drawBest(a),b.drawScale(a),b.drawKey(a),0>f&&d>e+c?window.setTimeout(function(){g(c)},1):f>0&&e+c>d?window.setTimeout(function(){g(c)},1):(a.beginPath(),a.clearRect(0,0,765,b.settings.hBox),a.fillStyle=b.settings.current,a.fillRect(b.settings.w*b.midPoint,5,d,30),a.closePath(),b.drawPar(a),b.drawBest(a),b.drawScale(a),b.drawKey(a))};g(0);var h=b.settings.prev,i=$.phylo.currentScore,j=h-i,k=function(c){a.beginPath(),a.clearRect(765,0,62,50),a.font="20pt Helvetica",a.fillStyle=b.settings.current,a.fillText(h+c,770,35),a.closePath(),j>0?c-=1:c+=1,0>j&&i>h+c?window.setTimeout(function(){k(c)},1):f>0&&h+c>i?window.setTimeout(function(){k(c)},1):(a.beginPath(),a.clearRect(765,0,62,50),a.font="20pt Helvetica",a.fillStyle=b.settings.current,a.fillText(i,770,35),a.closePath())};k(0)},drawKey:function(a){var b=this,c=window.lang.body.play.gameselect["game board"];a.beginPath(),a.fillStyle=b.settings.par,a.fillRect(0,13,10,5),a.font="10.5pt Helvetica",a.fillStyle=b.settings.color,a.fillText(c["field 2"],16,20),a.fillStyle=b.settings.current,a.fillRect(0,27,10,5),a.font="10.5pt Helvetica",a.fillStyle=b.settings.color,a.fillText(c["field 1"],16,35),a.fillStyle=b.settings.best,a.fillRect(0,42,10,5),a.font="10pt Helvetica",a.fillStyle=b.settings.color,a.fillText(c["field 4"],16,50),a.closePath()},drawScale2:function(a){var b=this;if(0==b.midPoint-b.settings.prevMid)return b.drawDelay(a),void 0;var c=function(d){a.beginPath(),a.clearRect(0,0,765,b.settings.hBox);for(var e=2;14>e;e++){if(d>=e){var f;f=5==d?5*(d-e):3*(d-e),a.moveTo(b.settings.w*e,0+f),a.lineTo(b.settings.w*e,50-f)}else{var f;f=5==d?1.5*e:5*(e-d),a.moveTo(b.settings.w*e,0+f),a.lineTo(b.settings.w*e,50-f)}2==e&&(a.font="9pt Helvetica",a.fillStyle=b.settings.color,a.fillText(b.minBorder,b.settings.w*e+3,50)),e==d&&(a.font="9pt Helvetica",a.fillStyle=b.settings.color,a.fillText("0",b.settings.w*e+3,50)),13==e&&(a.font="9pt Helvetica",a.fillStyle=b.settings.color,a.fillText(b.maxBorder,b.settings.w*e+3,50))}a.strokeStyle=b.settings.color,a.stroke(),a.closePath(),b.drawKey(a),b.midPoint>b.settings.prevMid&&d!=b.midPoint?window.setTimeout(function(){c(d+1)},20):b.midPoint<b.settings.prevMid&&d!=b.midPoint?window.setTimeout(function(){c(d-1)},20):(b.settings.prevMid=b.midPoint,b.drawDelay(a))};c(parseInt(b.settings.prevMid))},drawScale:function(a){var b=this;a.beginPath();for(var c=2;14>c;c++){if(c<=b.midPoint){var d;d=5==b.midPoint?5*(b.midPoint-c):3*(b.midPoint-c),a.moveTo(b.settings.w*c,0+d),a.lineTo(b.settings.w*c,50-d)}else{var d;d=5==b.midPoint?1.5*c:5*(c-b.midPoint),a.moveTo(b.settings.w*c,0+d),a.lineTo(b.settings.w*c,50-d)}2==c&&(a.font="9pt Helvetica",a.fillStyle=b.settings.color,a.fillText(b.minBorder,b.settings.w*c+3,50)),c==b.midPoint&&(a.font="9pt Helvetica",a.fillStyle=b.settings.color,a.fillText("0",b.settings.w*c+3,50)),13==c&&(a.font="9pt Helvetica",a.fillStyle=b.settings.color,a.fillText(b.maxBorder,b.settings.w*c+3,50))}a.strokeStyle=b.settings.color,a.stroke(),a.closePath()},getDistance:function(a){var b=this;if(0>a){var c=b.settings.w*b.midPoint,d=2*b.settings.w,e=-1*(c-d)/Math.abs(b.minBorder)*Math.abs(a);return-1*(c-d)>=e?-1*(c-d)-10:e}if(a>=0){var d=b.settings.w*b.midPoint,c=13*b.settings.w;return a<=b.maxBorder?(c-d)/b.maxBorder*a:b.settings.wBox-d-1.2*b.settings.w}},setBorder:function(){var a=$.sequence.par,b=this;10>a?(b.maxBorder=30,b.midPoint=9,b.minBorder=a-50):(b.maxBorder=a+20,b.midPoint=5,b.minBorder=-30)},drawPar:function(a){var b,c=$.sequence.par,d=this;a.beginPath(),a.fillStyle=d.settings.par,a.strokeStyle=d.settings.par,b=d.getDistance(c),a.moveTo(d.settings.w*d.midPoint+b-5,0),a.lineTo(d.settings.w*d.midPoint+b+5,0),a.lineTo(d.settings.w*d.midPoint+b,5),a.lineTo(d.settings.w*d.midPoint+b-5,0),a.stroke(),a.fill(),a.closePath()},drawBest:function(a){var b,c=$.phylo.bestScore,d=this;b=d.getDistance(c),a.beginPath(),a.fillStyle=d.settings.best,a.strokeStyle=d.settings.best,a.moveTo(d.settings.w*d.midPoint+b-5,40),a.lineTo(d.settings.w*d.midPoint+b+5,40),a.lineTo(d.settings.w*d.midPoint+b,35),a.lineTo(d.settings.w*d.midPoint+b-5,40),a.stroke(),a.fill(),a.closePath()},drawCurrent:function(a){var b,c=$.phylo.currentScore,d=this;b=d.getDistance(c),a.beginPath(),a.fillStyle=d.settings.current,a.fillRect(d.settings.w*d.midPoint,5,b,30),a.closePath()}}}(),function(){$.highlighter={set:function(){if("DNA"==$.main.type){$(".sequence").removeClass("highlighter-2");for(var a=$.phylo.tree[$.stage.current].ancestor,b=$.sequence.track,c=this.getActiveRows(),d=0;d<c.length;d++)for(j=0,arr=b[c[d]],len=b[c[d]].length;len>j;j++)try{"x"==a[j].toString().toLowerCase()||0==a[j]||$("#"+arr[j]).hasClass("nuc-"+a[j].toString().toUpperCase())||$("#"+arr[j]).addClass("highlighter-2")}catch(e){console.log("Warning : Cell(s) fell off the chart"),DEV.logging&&console.notify("Warning : Cell(s) fell off the chart")}}},getActiveRows:function(){var a=[];return $(".boardRow").each(function(){$(this).hasClass("current")&&a.push(parseInt($(this).attr("id").replace(/row/,"")))}),a},remove:function(){$(".sequence").removeClass("highlighter-2")}}}(),function(){$.helper={dump:function(a){for(var b="",c=0;c<a.length;c++){for(var d=0;d<a[c].length;d++)b+="&nbsp;"+a[c][d];b+="<br>"}$("#dump").html(b)},get:function(a){var b={};return document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g,function(){function a(a){return decodeURIComponent(a.split("+").join(" "))}b[a(arguments[1])]=a(arguments[2])}),b[a]},copy:function(a,b){for(var c=0;c<b.length;c++)for(var d=0;d<b[c].length;d++)try{a[c][d]=b[c][d]}catch(e){try{a[c].push(b[c][d])}catch(e){var f=[];f.push(b[c][d]),a.push(f)}}},popUp:function(a,b,c){void 0!=c?void 0!=c.cancel&&0==c.cancel&&$(".warning-cancel").hide():$(".warning-cancel").show(),$(".warning-bg").css({height:$(document).height(),width:$(document).width()}),$(".warning-bg").fadeIn(),$(".warning").fadeIn(),$(".warning-msg").html(a),$(".warning-ok").unbind().click(function(){b("ok"),$(".warning").fadeOut(),$(".warning-bg").fadeOut()}),$(".warning-cancel").unbind().click(function(){b("cancel"),$(".warning").fadeOut(),$(".warning-bg").fadeOut()})}},window.common={exportSingleton:function(a,b,c){if(!window[a])for(var d=window[a]=new b,e=0;e<c.length;e++)try{d[c[e][0]]=c[e][1]}catch(f){}}},String.prototype.toInt=function(){return parseInt(this.replace(/px/,""))}}(),function(){$.sequence={checkEachRowLength:function(){var a=$.phylo.origin;$.phylo.eachRowLength=[];for(var b=0,c=a.length;c>b;b++){for(var d=0,e=0,f=a[b].length;f>e;e++)"x"!=a[b][e]&&(d+=1);$.phylo.eachRowLength.push(d)}},nuc:function(a){return"x"==a?"x":this.nucleotide[a]},nucArray:function(a){var b=[];for(var c in a)"x"==a[c]?b.push("x"):b.push(this.nuc(a[c]));return b},createCache:function(){for(var a=[],b=0,c=$.phylo.rows,d=$.phylo.seqLen;c*d>b;b++)a.push(0);return $(".sequence").each(function(){var b=$(this).attr("id");a[b]=document.getElementById(b).style}),a},createCache2:function(){for(var a=[],b=0,c=$.phylo.rows,d=$.phylo.seqLen;c*d>b;b++)a.push(0);return $(".sequence").each(function(){var b=$(this).attr("id");a[b]=document.getElementById(b)}),a},calcPos:function(a){return 32*a+a},build:function(a){var b="",c=this;this.posList=[],this.posListReverse=[],this.nucleotide=[];for(var d=0,e=$.phylo.rows,f=$.phylo.seqLen;e*f>d;d++)this.posList.push(0),this.posListReverse.push(0),this.nucleotide.push(0);for(var d=0;d<a.length;d++){b+="<div class='boardRow hidden' id='row"+d+"'>";for(var g=0,h=0;h<a[d].length;h++){var i=a[d].charAt(h);"_"!=i&&(this.posList[d*$.phylo.seqLen+g]=g,this.nucleotide[d*$.phylo.seqLen+g]=a[d].charAt(h),b+="<div class='sequence "+this.colorTag(this.translate(i))+"' id='"+(d*$.phylo.seqLen+g)+"' style='left:"+this.calcPos(h)+"px;'></div>",g++)}for(var j=0;g>j;j++)this.posListReverse[d*$.phylo.seqLen+j]=g-j;b+="<div class='red-line' id='red"+d+"'></div>",b+="</div>"}$("#gameBoard").append("<div id='movingParts'>"+b+"<div>"),$(".boardRow").css("height",c.calcPos(1))},colorTag:function(a){return 1==a?"nuc-A":2==a?"nuc-G":3==a?"nuc-C":4==a?"nuc-T":void 0},color:function(a){return colorTag(a)},translate:function(a){return"A"==a?1:"G"==a?2:"C"==a?3:"T"==a?4:null},buildRootAncester:function(){},track:[],prepareTracking:function(a){this.track=[];for(var b=0;b<a.length;b++){for(var c=[],d=0,e=0;e<$.phylo.seqLen;e++)b<a.length&&e<a[b].length?"_"!=a[b].charAt(e)?(c.push(b*$.phylo.seqLen+d),d+=1):c.push("x"):c.push("x");this.track.push(c)}},intify:function(a){return"x"==a?a:parseInt(0)},randomize:function(b){var c,d=[];DEBUG&&(console.log(">> in random 1"),console.log(b));for(var e=0;e<b.length;e++){c=[];for(var f=0;f<$.phylo.seqLen;f++)"_"==b[e][f]?c.push("x"):""==b[e][f].toString()?c.push("x"):c.push(b[e][f]);d.push(c)}DEBUG&&(console.log(">> in random 2"),console.log(d));for(var e=0;e<d.length;e++){for(c=d[e].toString().split("x,").join("").split(",");(a=c.length)<$.phylo.seqLen;)c.splice(Math.floor(Math.random()*a),0,"x");c=c.map($.sequence.intify),d[e]=c.slice(0)}for(var b=[],e=0;e<d.length;e++){c="";for(var f=0;f<d[e].length;f++)c+="x"==d[e][f]?"_":d[e][f];b.push(c)}return b}}}(),function(){$.splash={countDown:function(a){var b=3;$("#countDown-text").html(3),$.splash.count=function(){if($.cookie.read("music-level"))try{var c=$.cookie.read("countdownVol");document.getElementById("startSound").volume=c,document.getElementById("countdownSound").volume=c}catch(d){}0==b?(document.getElementById("startSound").play(),document.getElementById("game-audio").play(),$("#countDown").fadeOut("fast"),console.log($.cookie.read("hasPlayed")),""===$.cookie.read("hasPlayed")&&$("#moveListener").trigger("showTut"),a()):($("#countDown-text").html(b),document.getElementById("countdownSound").play(),DEBUG&&console.log("counting down"),b-=1,setTimeout($.splash.count,1e3))},setTimeout($.splash.count,1e3)}}}(),function(){$.events={move:function(){$(".current").each(function(){var a=parseInt(this.id.replace(/row/,""));$(this).children().each(function(){if($(this).hasClass("sequence")){var b=this;$.events.touch(b,{start:function(){$.events.touch(document,{move:function(c){$("#chosenArea").hide(),$("#red"+a).show("fast"),$.physics.move(b,c)},end:function(){$("#red"+a).hide("fast"),$.events.untouch(document,"move"),$.events.untouch(document,"end"),$.physics.snap();var b=$.fitch.score();$.phylo.bestScore<b&&($.phylo.bestScore=b,$.helper.copy($.phylo.bestTrack,$.sequence.track),$.board.bestScore(b)),$.board.score(b),$.phylo.currentScore=b,$.board.stats(),b>=$.sequence.par?$.board.approve():$.board.unapprove(),$("#moveListener").trigger("newMove",{seq:$.sequence.track})}})}})}})})},untouch:function(a,b){var c="ontouchstart"in document.documentElement,d="ontouchmove"in document.documentElement,e="ontouchend"in document.documentElement,f="onmousedown"in document.documentElement,g="onmousemove"in document.documentElement,h="onmouseup"in document.documentElement;"start"==b&&(f&&$(a).unbind("mousedown"),c&&$(a).unbind("touchstart")),"move"==b&&(g&&$(a).unbind("mousemove"),d&&$(a).unbind("touchmove")),"end"==b&&(h&&$(a).unbind("mouseup"),e&&$(a).unbind("touchend"))},touch:function(a,b){var c="ontouchstart"in document.documentElement,d="ontouchmove"in document.documentElement,e="ontouchend"in document.documentElement,f="onmousedown"in document.documentElement,g="onmousemove"in document.documentElement,h="onmouseup"in document.documentElement,i=this;void 0!=b.start&&(f&&$(a).mousedown(function(a){b.start(i.getFingerPos(a))}),c&&$(a).bind("touchstart",function(a){a.preventDefault(),a.originalEvent.touches&&a.originalEvent.touches.length&&(a=a.originalEvent.touches[0]),b.start(i.getFingerPos(a))})),void 0!=b.move&&(g&&$(a).mousemove(function(a){b.move(i.getFingerPos(a))}),d&&$(a).bind("touchmove",function(a){a.preventDefault(),a.originalEvent.touches&&a.originalEvent.touches.length&&(a=a.originalEvent.touches[0]),b.move(i.getFingerPos(a))})),void 0!=b.end&&(h&&$(a).mouseup(function(a){b.end(i.getFingerPos(a))}),e&&$(a).bind("touchend",function(a){a.preventDefault(),a.originalEvent.touches&&a.originalEvent.touches.length&&(a=a.originalEvent.touches[0]),b.end(i.getFingerPos(a))}))},getFingerPos:function(a){var b=document.getElementById("game"),c=a.pageX-b.offsetLeft-185,d=a.pageY-b.offsetTop;return{pageX:c,pageY:d}},getMultiSelectFingerPos:function(a){var b=document.getElementById("game"),c=a.pageX-b.offsetLeft-5,d=a.pageY-b.offsetTop-65;return{pageX:c,pageY:d}}}}(),function(){var doc=document,win=window,url="/phpdb/openPhyloClassicDB.php";$.protocal={login:function(a,b,c){var d=7,e="mode="+d+"&user="+a+"&pass="+b;$.ajax({type:"POST",url:url,data:e}).done(function(a){c(a)}).fail(function(){$("div.login-warning").show().html("Could not connect to server, please try again later")})},register:function(a,b,c,d,e,f,g){var h=6,i="mode="+h+"&user="+a+"&displayname="+b+"&pass="+c+"&email="+d+"&network="+e+"&network_id="+f;$.ajax({type:"POST",url:url,data:i}).done(function(a){g(a)}).fail(function(){$("div.login-warning").show().html("Could not connect to server, please try again later")})},sendEndGameScore:function(status,fn){var mode=3;"completed"==status&&(mode=4);var data="mode="+mode+"&id="+$.phylo.id+"&user="+window.username+"&align="+$.board.getSubmissionAlignments()+"&score="+$.phylo.currentScore;$.ajax({type:"POST",url:url,data:data}).done(function(re){var json=eval("["+re+"]")[0];fn(json)}).fail(function(){console.log(">> failed to connect to database to submit end game score"),console.log(">> loading end game dummy data"),DEV.logging&&(devTools.prompts.notify({type:"error",title:"warning",text:"failed to connect to database to submit end game score"}),devTools.prompts.notify({type:"error",title:"warning",text:"loading end game dummy data"}));var dummy='{"0":"CONGENITAL PTOSIS","disease_link":"CONGENITAL PTOSIS","1":"67","play_count":"67","2":"13","fail_count":"13","3":"42","best_score":"42","4":"1375","running_score":"1375","5":"unki2aut","highscore_user":"unki2aut"}',json=eval("["+dummy+"]")[0];fn(json)})},sendHighScore:function(){return},getPuzzleInfo:function(){var data="mode=3&id="+$.phylo.id;$.ajax({type:"POST",url:url,data:data}).done(function(re){var json={};try{json=eval("["+re+"]")[0]}catch(err){return DEBUG&&console.log("@getPuzzleInfo error parsing"),void 0}}).fail(function(){})},read:function(a){if(void 0==a)this.type=$.helper.get("type"),this.score=$.helper.get(this.type);else{var b=a.type;this.tp=0,this.score=a.num,this.tp=b}},replay:function(){var data=$.protocal.previousData;DEBUG&&console.log(data);try{var j=eval("["+data+"]")[0].level}catch(err){return DEBUG&&console.log(err),void 0}$.phylo.id=j.attributes.id;for(var i=0;i<j.sequence.length;i++)j.sequence[i]=j.sequence[i].replace(/-/g,"_").toUpperCase();$.phylo.get={},$.phylo.get.sequence=j.sequence,DEBUG&&(j.sequence,j.tree),$.phylo.get.treeString=j.tree;var tree=$.newick.parse(j.tree);$.phylo.get.tree=tree,$.main.callBack()},request:function(setting){var str="",type=this.tp,score=this.score;"random"==type?str+="mode=1&diff="+score:"disease"==type?(mode=2,str+="mode=2&id="+score):"level"==type&&(mode=2,str+="mode=2&id="+score),$.ajax({url:url,data:str,type:"POST"}).done(function(data){data=data.replace("@",""),$.protocal.previousData=data,DEBUG^DEV.logging&&console.log(data);try{var j=eval("["+data+"]")[0].level}catch(err){return DEBUG&&console.log(err),void 0}$.phylo.id=j.attributes.id;for(var i=0;i<j.sequence.length;i++)j.sequence[i]=j.sequence[i].replace(/-/g,"_").toUpperCase();var numOfSeq=j.sequence.length,numOfNodes=j.tree.replace(/(\(|\)|\;)/,"").split(",").length;DEV.logging&&devTools.prompts.notify({title:"Puzzle Id",text:$.phylo.id}),numOfSeq!=numOfNodes&&(console.log(">> Detected Error -> Puzzle ("+$.phylo.id+") Sequence given ("+numOfSeq+") != phylo tree nodes ("+numOfNodes+")"),DEV.logging&&devTools.prompts.notify({type:"error",title:"warning",text:"Puzzle: "+$.phylo.id+"<br> #Seq("+numOfSeq+") / #Nodes("+numOfNodes+") mismatch"})),$.phylo.get={},$.phylo.get.sequence=j.sequence,DEBUG&&(j.sequence,j.tree),$.phylo.get.treeString=j.tree;var tree=$.newick.parse(j.tree);$.phylo.get.tree=tree,$.main.callBack()}).fail(function(){var dummy='{"level":{"attributes":{"id":"126"},"sequence":["CGGCCGCCGGGGG-------","CGGCCGCCGGGGG-------","CGGCCGCCGGGGG-------","CAACCCGTGGGTG-------","CGACCCGTGGATG-------","GCGGCGGCGGGCG-------","CGGCCGGCTGGGG-------","CCCCCCTCTCGGG-------","TCCCCCGAGGGAGGCGACCC"],"tree":"(((((hg19,gorGor1),papHam1),(((mm9,rn4),dipOrd1),cavPor3)),macEug1),ornAna1);"}}';console.log(">> Cannnot connect to database"),console.log(">> loading dummy data"),DEV.logging&&(devTools.prompts.notify({type:"error",title:"warning",text:"Cannot connect to database"}),devTools.prompts.notify({type:"error",title:"warning",text:"loading dummy data"})),$.protocal.previousData=dummy;try{var j=eval("["+dummy+"]")[0].level}catch(err){return DEBUG&&console.log(err),void 0}$.phylo.id=j.attributes.id;for(var i=0;i<j.sequence.length;i++)j.sequence[i]=j.sequence[i].replace(/-/g,"_").toUpperCase();var numOfSeq=j.sequence.length,numOfNodes=j.tree.replace(/(\(|\)|\;)/,"").split(",").length;numOfSeq!=numOfNodes&&(console.log(">> Detected Error -> Sequence given ("+numOfSeq+") != phylo tree nodes ("+numOfNodes+")"),DEV.logging&&devTools.prompts.notify({type:"error",title:"warning",text:"Puzzle: "+$.phylo.id+"<br> #Seq("+numOfSeq+") / #Nodes("+numOfNodes+") mismatch"})),$.phylo.get={},$.phylo.get.sequence=j.sequence,DEBUG&&(j.sequence,j.tree),$.phylo.get.treeString=j.tree;var tree=$.newick.parse(j.tree);$.phylo.get.tree=tree,$.main.callBack()})}}}(),function(){$.multiSelect={active:function(){var a=this;$("#movingParts").append("<div id='chosenArea'></div>"),$("#game").unbind().dblclick(function(b){$("#chosenArea").hide(),b=$.events.getMultiSelectFingerPos(b),a.startTheEvents(b)})},deactive:function(){$("#game").unbind()},startTheEvents:function(a){var b=this;$("#selectBox").css({top:a.pageY,left:a.pageX,height:0,width:0});var c={Y:a.pageY,X:a.pageX};$("#selectBox").show(),$("#game").mousemove(function(a){a=$.events.getMultiSelectFingerPos(a),a.pageY-c.Y>0&&a.pageX-c.X>0?$("#selectBox").css({height:a.pageY-c.Y,width:a.pageX-c.X}):a.pageY-c.Y<0&&a.pageX-c.X<0?$("#selectBox").css({top:a.pageY-10,left:a.pageX,height:c.Y-a.pageY,width:c.X-a.pageX}):a.pageY-c.Y<0&&a.pageX-c.X>0?$("#selectBox").css({top:a.pageY,height:c.Y-a.pageY,width:a.pageX-c.X}):a.pageY-c.Y>0&&a.pageX-c.X<0&&$("#selectBox").css({left:a.pageX,height:a.pageY-c.Y,width:c.X-a.pageX})}),$("#game").click(function(){$(this).unbind("mousemove"),$(this).unbind("click"),b.capture(),$("#selectBox").hide()})},capture:function(){var a={X:parseInt($("#selectBox").css("left").replace(/px/,""))-parseInt($("#tree").css("width").replace(/px/,""))-4,Y:parseInt($("#selectBox").css("top").replace(/px/,""))-150,H:parseInt($("#selectBox").css("height").replace(/px/,"")),W:parseInt($("#selectBox").css("width").replace(/px/,""))},b={X:1e3,Y:1e3,H:-1,W:-1},c=[],d=[];return $(".current > .sequence").each(function(){var e=this,f=parseInt($(this).parent().attr("id").replace(/row/,"")),g={X:parseInt($(this).css("left").replace(/px/,"")),Y:33*f,H:parseInt($(this).css("height").replace(/px/,"")),W:parseInt($(this).css("width").replace(/px/,""))};(g.Y<=a.Y&&a.Y<=g.Y+g.H&&a.X<=g.X&&g.X<=a.X+a.W||g.Y<=a.Y&&a.Y+a.H<=g.Y+g.H&&g.X<=a.X&&a.X+a.W<=g.X+g.W||a.Y<=g.Y&&g.Y<=a.Y+a.H&&a.X<=g.X&&g.X<=a.X+a.W||g.Y<=a.Y&&a.Y<=g.Y+g.H&&g.X<=a.X&&a.X<=g.X+g.W||g.Y<=a.Y&&a.Y<=g.Y+g.H&&g.X<=a.X+a.W&&a.X+a.W<=g.X+g.W||a.Y<=g.Y&&g.Y<=a.Y+a.H&&g.X<=a.X&&a.X<=g.X+g.W||a.Y<=g.Y&&g.Y<=a.Y+a.H&&g.X<=a.X+a.W&&a.X+a.W<=g.X+g.W||g.Y<=a.Y+a.H&&a.Y+a.H<=g.Y+g.H&&a.X<=g.X&&g.X<=a.X+a.W)&&(c.push(e),d.push($(e).attr("id")),g.X<b.X&&(b.X=g.X),g.Y<b.Y&&(console.log(g),b.Y=$("#"+$(e).attr("id")).offset().top-199),g.Y+g.H>b.H&&(b.H=g.Y+g.H),g.X+g.W>b.W&&(b.W=g.X+g.W))}),b.H-=b.Y,b.W-=b.X,0==c.length?($("#chosenArea").hide(),void 0):($("#chosenArea").css({top:b.Y-25,left:b.X,width:b.W,height:b.H+25}),$("#chosenArea").show(),$.events.touch("#chosenArea",{start:function(a){var e=a.pageX-b.X;$.events.touch(document,{move:function(a){$.physics.shift_select(c,d,{old:parseInt($("#chosenArea").css("left").replace(/px/,"")),"new":a.pageX-e,obj:$("#chosenArea")})},end:function(){$.events.untouch(document,"move"),$.events.untouch("#chosenArea","start"),c=[],d=[],$("#chosenArea").hide(),$.physics.snap("mutli");var a=$.fitch.score();$.board.score(a),$.board.stats(),$.phylo.bestScore<a&&($.phylo.bestScore=a,$.helper.copy($.phylo.bestTrack,$.sequence.track),$.board.bestScore(a)),a>=$.sequence.par?$.board.approve():$.board.unapprove()}})}}),void 0)}}}(),function(){$.lang={init:function(a){return a()}}}(),function(){var a="http://phylo.cs.mcgill.ca/profile/index.php?user=";$.endGame={complete:function(){var b=this;$.multiSelect.deactive(),$.protocal.sendEndGameScore("completed",function(c){b.events(),b.score("completed",c.best_score),b.submitterLocation=a+(c.submitter?c.submitter:"jerome"),b.submitter=c.submitter;var d=20-c.puzzles_completed>0?20-c.puzzles_completed:0,e=window.lang.body.play.gameselect["end of game"],f=e.headerMessage;$("#endGame-text").html(f),$("#endGame-learnMore-content").html(b.learnMore(c)),"guest"!=window.guest&&""!=window.guest?$("#endGame-learnMode-footerContent").html(e.replayMessage+"<br>"+e.completeXMessage.replace("***",d)+"<br><b>"+e.thankyouMessage+"<b>"):$("#endGame-learnMode-footerContent").html(e.replayMessage+"<br><b>"+e.thankyouMessage+"<b>"),$("#endGame").fadeIn(),csb.complete()})},bail:function(){var b=this;$.multiSelect.deactive(),$.protocal.sendEndGameScore("bail",function(c){b.events(),b.score("bail",c.best_score),b.submitter=c.submitter,b.submitterLocation=a+(c.submitter?c.submitter:"jerome");var d=20-c.puzzles_completed>0?20-c.puzzles_completed:0,e=window.lang.body.play.gameselect["end of game"],f=e.headerMessage;$("#endGame-text").html(f),$("#endGame-learnMore-content").html(b.learnMore(c)),"guest"!=window.guest&&""!=window.guest?$("#endGame-learnMode-footerContent").html(e.replayMessage+"<br>"+e.completeXMessage.replace("***",d)+"<br><b>"+e.thankyouMessage+"<b>"):$("#endGame-learnMode-footerContent").html(e.replayMessage+"<br><b>"+e.thankyouMessage+"<b>"),$("#endGame").fadeIn(),csb.complete()})},split:function(a){var b=a.split(":");return"<tr><td>"+$.trim(b[0])+"&nbsp;&nbsp;&nbsp;:</td><td>&nbsp;&nbsp;&nbsp;"+$.trim(b[1])+"</td></tr>"},learnMore:function(a){var b="<table>",c=this,d=window.lang.body.play.gameselect["end of game"];return b+=c.split(d.levelId.replace("***","<b>"+$.phylo.id+"</b>")),b+=c.split(d.userScore.replace("***","<b>"+$.phylo.currentScore+"</b>")),b+=c.split(d.avgScore.replace("***","<b>"+Math.round(a.running_score/a.play_count)+"</b>")),b+=c.split(d.highscore.replace("***","<b>"+a.best_score+"</b>")),b+=c.split(d.highscoreHolder.replace("***","<b>"+a.highscore_user+"</b>")),b+=c.split(d.dnaAssociation.replace("***","<b>"+(a.disease_link||window.lang.body.footer.unclassified)+"</b>")),b+=c.split(d.completions.replace("***","<b>"+a.play_count+"</b>")),b+="<tr><td>"+d.submitter+"&nbsp;&nbsp;&nbsp;:</td><td>&nbsp;&nbsp;&nbsp;<a href='"+c.submitterLocation+"'>"+(c.submitter?c.submitter:"jerome")+"</a></td></tr>",b+="</table>"},score:function(a,b){$("#musicPlayerSpot").html("");var c="<i class='icon-star-empty'></i><i class='icon-star-empty'></i><i class='icon-star-empty'></i>";if($("#endGame-score-result").html(c),$("#endGame-share").show(),"bail"!=a){var d=$.phylo.currentScore,e=$.sequence.par;c=d>e&&b>d?"<i class='icon-star-1'></i><i class='icon-star-1'></i><i class='icon-star-empty'></i>":d>=b?"<i class='icon-star-1'></i><i class='icon-star-1'></i><i class='icon-star-1'></i>":"<i class='icon-star-1'></i><i class='icon-star-empty'></i><i class='icon-star-empty'></i>",$("#endGame-score-result").html(c)}},share:function(){if(console.log("@share function"),!$.cookie.read("username"))return bootbox.alert(window.lang.body.social["field 29"]),$.cookie.delete("username"),$.cookie.delete("fullname"),$.cookie.delete("loginmode"),$.cookie.delete("logid"),$("#logout").hide(),window.guest="guest",$("#login-box").hide(),$(".login-btn").click(function(){eClick()}),$("#login-tag").html(window.lang.body.play.gameselect.login["field 2"]),$(".showInLogin").hide(),void 0;$.cookie.read("username");var a=$.cookie.read("fullname"),b=$.cookie.read("loginmode"),c=$.cookie.read("logid");
if("Facebook"==b||"Twitter"==b||"LinkedIn"==b||"Google"==b)$.protocal.sendEndGameScore("info",function(d){var e=d.disease_link;if(d.best_score,"Facebook"==b){if(e)if($.phylo.currentScore>=e)var f=a.replace("+"," ")+" "+window.lang.body.social["field 7"].replace("***",e)+"\n"+window.lang.body.social["field 20"];else var f=a.replace("+"," ")+" "+window.lang.body.social["field 8"].replace("***",e)+"\n"+window.lang.body.social["field 20"];else if($.phylo.currentScore>=e)var f=a.replace("+"," ")+" "+window.lang.body.social["field 9"]+".\n"+window.lang.body.social["field 20"];else var f=a.replace("+"," ")+" "+window.lang.body.social["field 10"]+".";var g=window.lang.body.social["field 31"],d="provider="+b+"&id="+c+"&caption="+g+"&description="+f}else if("Twitter"==b){if(e)if($.phylo.currentScore>=e)var f=window.lang.body.social["field 20"]+" phylo.cs.mcgill.ca";else var f=window.lang.body.social["field 20"]+" phylo.cs.mcgill.ca";else if($.phylo.currentScore>=e)var f=window.lang.body.social["field 20"]+" phylo.cs.mcgill.ca";else var f=window.lang.body.social["field 20"]+" phylo.cs.mcgill.ca";var d="provider="+b+"&id="+c+"&description="+f}else if("LinkedIn"==b){if(e)if($.phylo.currentScore>=e)var f=a.replace("+"," ")+" "+window.lang.body.social["field 15"].replace("***",e)+"\n"+window.lang.body.social["field 20"];else var f=a.replace("+"," ")+" "+window.lang.body.social["field 16"].replace("***",e)+"\n"+window.lang.body.social["field 20"];else if($.phylo.currentScore>=e)var f=a.replace("+"," ")+" "+window.lang.body.social["field 17"]+".\n"+window.lang.body.social["field 20"];else var f=a.replace("+"," ")+" "+window.lang.body.social["field 18"]+".\n"+window.lang.body.social["field 20"];var d="provider="+b+"&id="+c+"&description="+f}else if("Google"==b){if(e)if($.phylo.currentScore>=e)var f=a.replace("+"," ")+" "+window.lang.body.social["field 15"].replace("***",e)+"\n"+window.lang.body.social["field 20"];else var f=a.replace("+"," ")+" "+window.lang.body.social["field 16"].replace("***",e)+"\n"+window.lang.body.social["field 20"];else if($.phylo.currentScore>=e)var f=a.replace("+"," ")+" "+window.lang.body.social["field 17"]+".\n"+window.lang.body.social["field 20"];else var f=a.replace("+"," ")+" "+window.lang.body.social["field 18"]+".\n"+window.lang.body.social["field 20"];var d="provider="+b+"&id="+c+"&description="+f}var h={message:window.lang.body.social["field 22"]+"<br/>via "+b+"<br/>\n"+f,buttons:{confirm:{label:window.lang.body.social["field 25"],"class":"btn-success",callback:function(){$.ajax({type:"POST",url:"http://phylo.cs.mcgill.ca/phpdb/social/feed.php",data:d}).done(function(){}).fail(function(){bootbox.alert(window.lang.body.social["field 23"])})}},cancel:{label:window.lang.body.social["field 27"]}}};bootbox.dialog(h)});else{if("Classic"!==b)return DEBUG&&console.log(window.lang.body.social["field 28"].replace("***",b)),void 0;var d={message:window.lang.body.social["field 44"],buttons:{ok:{}}};bootbox.dialog(d)}},events:function(){langFiles=window.lang.body.play.gameselect["end of game"],$("#endGame-new button").html(langFiles["field 11"]).unbind().click(function(){$("#game").hide(),$("#endGame").fadeOut(),interactiveMenu.restart(),$("#draw").show(),$("#menu").fadeIn()}),$("#endGame-replay button").html(langFiles["field 12"]).unbind().click(function(){$.main.clear(),$("#endGame").fadeOut(),$("#tree").html(""),$("#gameBoard").html("<img src='assets/img/loading.gif'/>"),$.protocal.replay(),$("#countDown-text").html("<img src='assets/img/loading.gif'/>"),$("#countDown").fadeIn()}),$("#endGame-share button").html(langFiles["field 13"]).unbind().click(function(){DEBUG&&console.log("Click share event"),$.endGame.share("test")})},runAway:function(){$("#runaway").unbind().click(function(){options={message:window.lang.body.misc["field 19"],buttons:{confirm:{label:window.lang.body.misc["field 18"],callback:function(){$.timer.active=!1,$.endGame.bail()}},cancel:{label:window.lang.body.misc["field 16"]}}},bootbox.dialog(options)})}}}(),function(){$.physics={shift_select:function(a,b,c){var d=!0;$.sequence.posList,$.sequence.posListReverse;var e=$.phylo.domCache,f=$.sequence.track,g=c.new-c.old;c.new-c.old>0&&(d=!1);var h=parseInt(c.obj.css("width").replace(/px/,""));d?c.new<0&&(c.new=c.old):c.new+h>$.sequence.calcPos($.phylo.seqLen)&&(c.new=$.sequence.calcPos($.phylo.seqLen)-h);for(var i=function(b){for(var c in a)if($(a[c]).attr("id")==b)return!0;return!1},j=[],k=0,l=a.length;l>k;k++){var m=$(a[k]).parent().attr("id").toString().replace(/row/,"");m in j||j.push(m)}var n=0,o=b[0],p=$.phylo.seqLen;if(d){for(var q=827,m=0;m<j.length;m++)for(var r=f[j[m]],s=0,t=!1,k=0,l=r.length;l>k;k++)if("x"!=r[k]){for(var u=0;u<b.length;u++)if(r[k]==b[u]){s>=n&&(n=s,o=b[u],q=parseInt(e[b[u]].left.replace(/px/,""))),t=!0;break}if(t)break;s+=1}var v=e[o].left.replace(/px/,""),w=$.sequence.calcPos(n),x=v-w;parseInt(v)+g<w&&(g=-1*x)}else{o=b[b.length-1];var q=0;p=0;for(var m=0;m<j.length;m++)for(var r=f[j[m]],s=1,t=!1,k=r.length-1;k>=0;k--)if("x"!=r[k]){for(var u=$.phylo.seqLen-1;u>=0;u--)if(r[k]==b[u]&&void 0!=r[k]){s>=p&&(p=s,o=b[u],q=parseInt(e[b[u]].left.replace(/px/,""))),t=!0;break}if(t)break;s+=1}p=$.phylo.seqLen-p;var v=e[o].left.replace(/px/,""),y=$.sequence.calcPos(p),x=y-v;parseInt(v)+g>y&&(g=x)}if(0!=g){c.obj.css({left:c.old+g});for(var z=0,l=a.length;l>z;z++){var A=parseInt($(a[z]).css("left").replace(/px/,""));A+(c.new-c.old);var B=parseInt($(a[z]).attr("id"));if(d){if(void 0!=e[B-1]&&void 0!=e[B-1].left&&i(B-1)){$(a[z]).css({left:A+g});continue}}else if(void 0!=e[B+1]&&void 0!=e[B+1].left&&i(B+1)){$(a[z]).css({left:A+g});continue}if(d)for(;;){var C=B%$.phylo.seqLen;if(void 0==e[B]^0==e[B])break;if(void 0==e[B-1]^0==e[B-1]){var D=parseInt(e[B].left.replace(/px/,""))+g;e[B].left=D<$.sequence.calcPos(C)?$.sequence.calcPos(C)+"px":D+"px";break}var E=parseInt(e[B].left.replace(/px/,"")),F=parseInt(e[B-1].left.replace(/px/,""))+$.phylo.x,D=E+g;if(e[B].left=D<$.sequence.calcPos(C)?$.sequence.calcPos(C)+"px":D+"px",B-=1,!(F>D))break}else for(;;){var G=Math.floor(B/$.phylo.seqLen),C=$.phylo.seqLen-($.phylo.eachRowLength[G]-B%$.phylo.seqLen);if(void 0==e[B]^0==e[B])break;if(void 0==e[B+1]^0==e[B+1]){var D=parseInt(e[B].left.replace(/px/,""))+g;e[B].left=D>$.sequence.calcPos(C)?$.sequence.calcPos(C)+"px":D+"px";break}var E=parseInt(e[B].left.replace(/px/,"")),F=parseInt(e[B+1].left.replace(/px/,"")),D=E+g+$.phylo.x;if(e[B].left=D-$.phylo.x>$.sequence.calcPos(C)?$.sequence.calcPos(C)+"px":E+g+"px",B+=1,!(D>F))break}}return!0}},move:function(a,b){var c=parseInt($(a).css("left").replace(/px/,"")),d=parseInt($.phylo.offSet);if(b.pageX-d-$.phylo.x/2>c)this.shift(!0,parseInt(a.id),b,0);else{if(b.pageX-d-$.phylo.x/2==c)return;this.shift(!1,parseInt(a.id),b,0)}},shift:function(a,b,c,d){var e=$.phylo.domCache,f=parseInt(b),g=parseInt($.phylo.offSet),h=$.sequence.posList,i=$.sequence.posListReverse;if(a)for(;;){e[f].zIndex=100-d;var j=c.pageX,k=$.phylo.x*$.phylo.seqLen+g,l=c.pageX+(d-.5)*$.phylo.x-g;if(l>=($.phylo.seqLen-i[f])*$.phylo.x-22&&(l=($.phylo.seqLen-i[f])*$.phylo.x-22),0==e[f+1]){e[f].left=l+"px";break}if(void 0==e[f+1]){e[f].left=l+"px";break}if(!(c.pageX-g+d*$.phylo.x>parseInt(e[f+1].left)-$.phylo.x/2)){e[f].left=l+"px";break}if(e[f].left=l+"px",d+=1,f+=1,0==e[f])break;if(void 0==e[f])break}else for(;;){var j=g,k=c.pageX,l=c.pageX+(d-.5)*$.phylo.x-g;if(j>=k)break;if(l<h[f]*$.phylo.x&&(l=h[f]*$.phylo.x),h[f]*$.phylo.x>=parseInt(e[f].left))break;if(0==e[f-1]){e[f].left=l+"px";break}if(void 0==e[f-1]){e[f].left=l+"px";break}if(!(parseInt(e[f-1].left)>c.pageX-g+d*$.phylo.x-3*$.phylo.x/2)){e[f].left=l+"px";break}if(e[f].left=l+"px",d--,f-=1,void 0==e[f])break;if(0==e[f])break}},snapRandom:function(){for(var a=$.sequence.track,b=$.phylo.domCache,c=0;c<a.length;c++)for(var d=0;d<a[c].length;d++)"x"!=a[c][d]&&(b[a[c][d]].left=$.sequence.calcPos(d)+"px")},snap:function(){var a=function(a){for(var a=parseInt(a),b=0;b<$.sequence.track.length&&!(b*$.phylo.seqLen<=a&&a<b*$.phylo.seqLen+$.phylo.seqLen);b++);return b},b=$.sequence.track,c=$.phylo.domCache;$.sequence.posList;for(var d=0;d<b.length;d++)for(var e=0;e<b[d].length;e++)b[d][e]="x";$(".sequence").each(function(){var d=$(this).attr("id"),e=parseInt(c[d].left)-1,f=parseInt(e/$.phylo.x),g=a(d);for($.sequence.calcPos(f)-e<=0&&(f+=1),0>f&&(f=0);"x"!=b[g][f]&&f<2*$.phylo.seqLen;)f+=1;if(f>=$.phylo.seqLen)for(var h=b[g].length,i=d;h--;){if("x"==b[g][h]){b[g][h]=d,c[d].left=$.sequence.calcPos(h)+"px";break}i=b[g][h],b[g][h]=d,c[d].left=$.sequence.calcPos(h)+"px",d=i}else c[d].left=$.sequence.calcPos(f)+"px",b[g][f]=d}),DEBUG&&$.helper.dump(b)}}}(),function(){$.engine={deActive:function(){$(".current").each(function(){$(this).children().each(function(){if($(this).hasClass("sequence")){var a=this;$.events.untouch(a,"start")}})})},active:function(){$.events.move()}}}(),function(){$.fitch={score:function(){if("DNA"==$.main.type){void 0==$.stage.stats&&($.stage.stats={}),$.stage.stats.match=0,$.stage.stats.mismatch=0,$.stage.stats.open=0,$.stage.stats.extend=0,$.fitch.forwardBackward();var a=$.fitch.scoreRecurse($.stage.current);return a}},getLen:function(){return $.phylo.seqLen},forwardBackward:function(){for(var a=$.stage.current,b=$.fitch.getLen(),c=0;b>c;c++){var d=$.fitch.forward(a,c);$.phylo.tree[a].ancestor[c]=d.length<1?"x":1==d.length||0!=d.indexOf("x")?d[0]:d[1],$.phylo.tree[a].child>=2&&$.fitch.backward($.phylo.tree[a].node1,$.phylo.tree[a].ancestor[c],c),$.phylo.tree[a].child>=1&&$.fitch.backward($.phylo.tree[a].node2,$.phylo.tree[a].ancestor[c],c)}},forward:function(a,b){if(0==b&&($.phylo.tree[a].ancestor=[],$.phylo.tree[a].ancestorSet=[]),2==$.phylo.tree[a].child){for(var c=$.fitch.forward($.phylo.tree[a].node2,b),d=$.fitch.forward($.phylo.tree[a].node1,b),e=[],f=[],g=0;g<c.length;g++){-1==e.indexOf(c[g])&&e.push(c[g]);for(var h=0;h<d.length;h++)c[g]==d[h]&&-1==f.indexOf(c[g])&&f.push(c[g]),-1==e.indexOf(d[h])&&e.push(d[h])}$.phylo.tree[a].ancestorSet[b]=f.length<1?e:f}else if(1==$.phylo.tree[a].child){var c=$.fitch.forward($.phylo.tree[a].node2,b),d=$.sequence.nuc($.sequence.track[$.phylo.tree[a].node1][b]);$.phylo.tree[a].ancestorSet[b]=c.indexOf(d)>-1?[d]:c.concat([d])}else{var c=$.sequence.nuc($.sequence.track[$.phylo.tree[a].node1][b]),d=$.sequence.nuc($.sequence.track[$.phylo.tree[a].node2][b]);$.phylo.tree[a].ancestorSet[b]=d==c?[c]:[c,d]}return $.phylo.tree[a].ancestorSet[b]},backward:function(a,b,c){var d=$.phylo.tree[a].ancestorSet[c];$.phylo.tree[a].ancestor[c]=d.length<1?"x":1==d.length?d[0]:d.indexOf(b)>-1?b:0!=d.indexOf("x")?d[0]:d[1],$.phylo.tree[a].child>=2&&$.fitch.backward($.phylo.tree[a].node1,$.phylo.tree[a].ancestor[c],c),$.phylo.tree[a].child>=1&&$.fitch.backward($.phylo.tree[a].node2,$.phylo.tree[a].ancestor[c],c)},forwardBackward2:function(){for(var a=$.stage.current,b=$.fitch.getLen(),c=$.fitch.forward2(a,d),d=0;b>d;d++)$.phylo.tree[a].ancestor[d]=c[d].length<1?"x":1==c[d].length||0!=c[d].indexOf("x")?c[d][0]:c[d][1];$.phylo.tree[a].child>=2&&$.fitch.backward2($.phylo.tree[a].node1,$.phylo.tree[a].ancestor),$.phylo.tree[a].child>=1&&$.fitch.backward2($.phylo.tree[a].node2,$.phylo.tree[a].ancestor)},forward2:function(a){var b=$.fitch.getLen();if($.phylo.tree[a].ancestor=[],$.phylo.tree[a].ancestorSet=[],2==$.phylo.tree[a].child)for(var c=$.fitch.forward2($.phylo.tree[a].node2),d=$.fitch.forward2($.phylo.tree[a].node1),e=0;b>e;e++){for(var f=[],g=[],h=0;h<c[e].length;h++){-1==f.indexOf(c[e][h])&&f.push(c[e][h]);for(var i=0;i<d.length;i++)c[e][h]==d[e][i]&&-1==g.indexOf(c[e][h])&&g.push(c[e][h]),-1==f.indexOf(d[e][i])&&f.push(d[e][i])}$.phylo.tree[a].ancestorSet[e]=g.length<1?f:g}else if(1==$.phylo.tree[a].child)for(var c=$.fitch.forward2($.phylo.tree[a].node2),d=$.sequence.nucArray($.sequence.track[$.phylo.tree[a].node1]),e=0;b>e;e++)$.phylo.tree[a].ancestorSet[e]=c[e].indexOf(d[e])>-1?[d[e]]:c[e].concat([d[e]]);else for(var c=$.sequence.nucArray($.sequence.track[$.phylo.tree[a].node1]),d=$.sequence.nucArray($.sequence.track[$.phylo.tree[a].node2]),e=0;b>e;e++)$.phylo.tree[a].ancestorSet[e]=d==c?[c[e]]:[c[e],d[e]];return $.phylo.tree[a].ancestorSet},backward2:function(a,b){for(var c=$.phylo.tree[a].ancestorSet,d=$.fitch.getLen(),e=0;d>e;e++)$.phylo.tree[a].ancestor[e]=c[e].length<1?"x":1==c[e].length?c[e][0]:c[e].indexOf(b[e])>-1?b[e]:0!=c[e].indexOf("x")?c[e][0]:c[e][1];$.phylo.tree[a].child>=2&&$.fitch.backward2($.phylo.tree[a].node1,$.phylo.tree[a].ancestor),$.phylo.tree[a].child>=1&&$.fitch.backward2($.phylo.tree[a].node2,$.phylo.tree[a].ancestor)},scoreRecurse:function(a){function b(a){var b={match:1,mismatch:-1,open:-4,extend:-1};return a.match*b.match+a.mismatch*b.mismatch+a.open*b.open+a.extend*b.extend}function c(a,b){function c(a){return"x"==a}for(var d={match:0,mismatch:0,open:0,extend:0},e=a.length-a.filter(c).length,f=b.length-b.filter(c).length,g=0,h=0,i=0,j=0;j<a.length;j++)("x"!=a[j]||"x"!=b[j])&&("x"!=a[j]&&"x"!=b[j]?(b[j]==a[j]?d.match++:d.mismatch++,g++,h++,i=0):"x"!=a[j]&&"x"==b[j]?(h>0&&f>h&&(1==i?d.extend++:(d.open++,i=1)),g++):"x"==a[j]&&"x"!=b[j]&&(g>0&&e>g&&(2==i?d.extend++:(d.open++,i=2)),h++));return d}if(0==$.phylo.tree[a].child)var d=$.sequence.nucArray($.sequence.track[$.phylo.tree[a].node1]),e=$.sequence.nucArray($.sequence.track[$.phylo.tree[a].node2]);else if(1==$.phylo.tree[a].child)var d=$.sequence.nucArray($.sequence.track[$.phylo.tree[a].node1]),e=$.phylo.tree[$.phylo.tree[a].node2].ancestor;else var d=$.phylo.tree[$.phylo.tree[a].node1].ancestor,e=$.phylo.tree[$.phylo.tree[a].node2].ancestor;var f=c($.phylo.tree[a].ancestor,d),g=c($.phylo.tree[a].ancestor,e),h=b(f)+b(g);return $.stage.stats.match+=parseInt(f.match)+parseInt(g.match),$.stage.stats.mismatch+=parseInt(f.mismatch)+parseInt(g.mismatch),$.stage.stats.open+=parseInt(f.open)+parseInt(g.open),$.stage.stats.extend+=parseInt(f.extend)+parseInt(g.extend),$.phylo.tree[a].child>=2&&(h+=$.fitch.scoreRecurse($.phylo.tree[a].node1)),$.phylo.tree[a].child>=1&&(h+=$.fitch.scoreRecurse($.phylo.tree[a].node2)),$.phylo.tree[a].score=h,h}}}(),function(){$.tree={build:function(a){var b=0,c=0,d=[],e=function(a,f){if(void 0==a.branchset)return a.name;var g=a.branchset[0],h=a.branchset[1];if(void 0==g.branchset&&void 0==h.branchset)var i={lv:b++,depth:f,child:0,node1:c++,node2:c++,p1:g.name,p2:h.name};else if(void 0==g.branchset){var i={lv:-1,depth:f,child:1,node1:c++,node2:-1,p1:g.name};i.node2=e(h,f+1).lv,i.lv=b++}else if(void 0==h.branchset){var i={lv:-1,depth:f,child:1,node1:-1,node2:-1,p1:h.name};i.node2=e(g,f+1).lv,i.node1=c++,i.lv=b++}else{var i={lv:-1,depth:f,child:2,node1:-1,node2:-1};i.node1=e(g,f+1).lv,i.node2=e(h,f+1).lv,i.lv=b++}return d.push(i),i};return e(a,0),d},buildAncestor:function(){for(var a=$.stage.current,b="",c=this,d=$.phylo.tree[0].depth>=4?$.phylo.tree[0].depth:4,e=178,f=20,g=(e-d*f)/d,h=function(a){var b=$.phylo.tree[a];return 0==b.child?(b.node1+b.node2)/2:1==b.child?(b.node1+h(b.node2))/2:2==b.child?(h(b.node1)+h(b.node2))/2:void 0},i=function(a){var b="",c=function(a){var b=$.phylo.tree[a];if(0==b.child)return{top:34*(b.node1+.5)+7+8,depth:b.depth};if(1==b.child){var c=(b.node1+h(b.node2))/2;return c=34*c+7+8,{top:c,depth:b.depth}}if(2==b.child){var c=(h(b.node1)+h(b.node2))/2;return c=34*c+7+8,{top:c,depth:b.depth}}},d=178;d-=32;var e=a.node1<a.node2?a.node1+"v"+a.node2:a.node2+"v"+a.node1;if(0==a.child){var f=a.depth*g+10.2,i=34*a.node1+17-2,j=34*a.node2+17-2,k=Math.abs(j-i);b+="<div class='vLine "+e+"' style='top:"+i+"px;left:"+f+"px;height:"+k+"px'></div>",b+="<div class='hLine h"+a.node1+"' style='top:"+i+"px;left:"+f+"px;width:"+(d-f)+"px'></div>",b+="<div class='hLine h"+a.node2+"' style='top:"+j+"px;left:"+f+"px;width:"+(d-f)+"px'></div>"}else if(1==a.child){var f=a.depth*g+10.2,l=c(a.node2),i=34*a.node1+17-2,j=l.top,m=g*Math.abs(a.depth-l.depth),k=Math.abs(j-i);b+="<div class='vLine "+e+"' style='top:"+(j>i?i:j)+"px;left:"+f+"px;height:"+k+"px'></div>",b+="<div class='hLine h"+a.node1+"' style='top:"+i+"px;left:"+f+"px;width:"+(d-f)+"px'></div>",b+="<div class='hLine h"+a.node2+"' style='top:"+j+"px;left:"+f+"px;width:"+m+"px'></div>"}else if(2==a.child){var f=a.depth*g+10.2,n=c(a.node1),o=c(a.node2),i=n.top,p=g*Math.abs(a.depth-n.depth),j=o.top,q=g*Math.abs(a.depth-o.depth),k=j-i;b+="<div class='vLine "+e+"' style='top:"+i+"px;left:"+f+"px;height:"+k+"px'></div>",b+="<div class='hLine h"+a.node1+"' style='top:"+i+"px;left:"+f+"px;width:"+p+"px'></div>",b+="<div class='hLine  h"+a.node2+"' style='top:"+j+"px;left:"+f+"px;width:"+q+"px'></div>"}return b},j=function(a){var d=$.phylo.tree[a];if(0==d.child)return b+="<div class='ancestorImg' style='top:"+34*d.node1+"px'><img src='"+c.getImg(d.p1)+"'/></div>",b+="<div class='ancestorImg' style='top:"+34*d.node2+"px'><img src='"+c.getImg(d.p2)+"'/></div>",b+="<div class='nodeImg' id='node"+a+"' style='left:"+d.depth*g+"px;top:"+(34*(d.node1+.5)+7)+"px'></div>",b+=i(d),void 0;if(1==d.child){var e=(d.node1+h(d.node2))/2;e=34*e+7,b+="<div class='ancestorImg' style='top:"+34*d.node1+"px'><img src='"+c.getImg(d.p1)+"'/></div>",b+="<div class='nodeImg' id='node"+a+"' style='left:"+d.depth*g+"px;top:"+e+"px'></div>",b+=i(d)}else if(2==d.child){var e=(h(d.node1)+h(d.node2))/2;e=34*e+7,b+="<div class='nodeImg' id='node"+a+"' style='left:"+d.depth*g+"px;top:"+e+"px'></div>",b+=i(d)}},k=0;a>=k;k++)j(k);$("#tree").html(b),$(".nodeImg").hover(function(){for(var a=$(this).attr("id").replace(/node/,""),b="",c=0;c<$.phylo.tree[a].ancestor.length;c++){var d=$.phylo.tree[a].ancestor[c];$.sequence,"x"!=d&&0!=d&&(b+="<div class='ancestor "+$.sequence.colorTag($.sequence.translate(d))+"' style='left:"+$.sequence.calcPos(c)+"px;'></div>")}$("#ancestorSeq").html(b),$("#ancestorSeq").show("slide",{direction:"left"},500)},function(){$("#ancestorSeq").hide()})},getImg:function(a){return"thankyou"==a?this.ty:"hg19"==a||"GRCh37"==a||"human"==a||"Human"==a?this.collect("Human"):"panTro2"==a||"gorGor1"==a||"ape"==a||"Ape"==a?this.collect("ape"):"ponAbe2"==a||"rheMac2"==a||"papHam1"==a||"calJac1"==a||"tarSyr1"==a||"micMur1"==a||"otoGar1"==a||"monkey"==a||"Monkey"==a?this.collect("Monkey"):"tupBel1"==a||"mm9"==a||"rn4"==a||"dipOrd1"==a||"cavPor3"==a||"eriEur1"==a||"sorAra1"==a||"mouse"==a||"Mouse"==a?this.collect("Mouse"):"speTri1"==a||"squirrel"==a||"Squirrel"==a?this.collect("Squirell"):"oryCun2"==a||"rabbit"==a||"Rabbit"==a?this.collect("Rabbit"):"ochPri2"==a||"ram"==a||"Ram"==a?this.collect("Ram"):"turTru2"==a||"dolphin"==a||"Dolphin"==a?this.collect("Dolphin"):"bosTau4"==a||"cow"==a||"Cow"==a||"taurus"==a||"Taurus"==a?this.collect("Cow"):"equCab2"==a||"horse"==a||"Horse"==a||"donkey"==a||"Donkey"==a?this.collect("Horse"):"felCat3"==a||"cat"==a||"Cat"==a||"lion"==a||"Lion"==a||"tiger"==a||"Tiger"==a||"panther"==a||"Panther"==a||"jaguar"==a||"Jaguar"==a||"lynx"==a||"Lynx"==a?this.collect("Cat"):"canFam2"==a||"dog"==a||"Dog"==a||"wolf"==a||"Wolf"==a?this.collect("Dog"):this.collect("bat")},collect:function(a){return"assets/img/animal/"+a.toLowerCase()+".svg"}}}(),function(){$(document).ready(function(){$.main={type:"DNA",clear:function(){$.timer.stop(),$.stage.current=-1,$("#countDown-text").html('<img src="img/loading.gif>'),$("#countDown").show(),$("#endGame").hide()},init:function(a){this.clear(),height=void 0==$("#tree").css("height")?178:$("#tree").css("height").replace(/px/,""),$.endGame.runAway(),$.phylo={seqLen:25,x:34,offSet:0,height:height,rows:10},$.lang.init(function(){$("#game").show(),$.protocal.read(a),$.protocal.request()})},callBack:function(){$.events.touch("#gameBoard",{start:function(){},move:function(){},end:function(){}});var a="onmousemove"in document.documentElement;DEBUG&&console.log($.phylo),$.phylo.tree=$.tree.build($.phylo.get.tree),$.board.build(),$.sequence.build($.phylo.get.sequence),$.sequence.prepareTracking($.phylo.get.sequence),$.phylo.origin=[];for(var b=0;8>b;b++){for(var c=[],d=0;d<$.phylo.seqLen;d++)c.push(0);$.phylo.origin.push(c)}$.helper.copy($.phylo.origin,$.sequence.track),DEBUG&&(console.log("Before Random"),console.log($.sequence.track));var e=$.sequence.randomize($.sequence.track);$.sequence.prepareTracking(e),DEBUG&&(console.log("Randomized Sequence"),console.log(e)),$.phylo.domCache=$.sequence.createCache(),$.physics.snapRandom(),DEBUG&&(console.log("original"),console.log($.phylo.origin),console.log("tracked"),console.log($.sequence.track),console.log($.phylo.tree)),$.stage.last=$.phylo.tree[$.phylo.tree.length-1].lv,window.DEV.disableSplash?($("#countDown").hide(),$.stage.end=!1,$.stage.round(),DEBUG&&$.helper.dump($.sequence.track),a&&$.multiSelect.active()):($("#countDown").show(),$.splash.countDown(function(){$.stage.end=!1,$.stage.round(),DEBUG&&$.helper.dump($.sequence.track),a&&$.multiSelect.active()})),$.sequence.checkEachRowLength(),$.board.startListener(),$("moveListener").trigger("newGame"),$("#moveListener").trigger("newMove",{seq:$.sequence.track})}}})}();